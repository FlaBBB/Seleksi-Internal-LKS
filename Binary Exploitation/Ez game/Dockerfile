# Use a lightweight Linux distribution
FROM ubuntu:22.04

# Install necessary tools and dependencies
RUN apt-get update && apt-get install -y \
    socat \
    && rm -rf /var/lib/apt/lists/*

# Create a user for the challenge
RUN useradd -m ctf

# Copy the challenge binary and flag
WORKDIR /home/ctf
COPY chall ./chall
COPY flag.txt ./flag.txt

# Ensure permissions are correct
RUN chown -R ctf:ctf /home/ctf && chmod 700 /home/ctf/chall && chmod 600 /home/ctf/flag.txt

# Drop privileges to the ctf user
USER ctf

# Run the challenge using socat
CMD ["socat", "TCP-LISTEN:13238,reuseaddr,fork", "EXEC:/home/ctf/chall,pty,raw,echo=0"]
