<?php
session_start();
header('Content-Type: application/json');

$users = [
    'user' => [
        'password' => 'user123',
        'role' => 'user'
    ],
    'admin' => [
        'password' => '$023IJRWEOIRHJ923HT$!@#$%^&*{}::l',
        'role' => 'admin'
    ]
];

function response($status, $message, $data = null) {
    echo json_encode([
        'status' => $status,
        'message' => $message,
        'data' => $data
    ]);
    exit();
}

$action = $_REQUEST['action'] ?? '';

switch($action) {

    // add a new case to display list api
    case 'list':
        if(!isset($_SESSION['username'])) {
            response('error', 'Not authenticated');
        }
        response('success', 'List retrieved', [
            'username' => $_SESSION['username'],
            'role' => $_SESSION['role'],
            'api-list' => [
                'list' => 'List API',
                'login' => 'Login',
                'profile' => 'Profile',
                'update-profile' => 'Update Profile',
                'get-flag' => 'Get Flag',
                'logout' => 'Logout'
            ]
        ]);
        break;
        case 'login':
            $username = $_POST['username'] ?? '';
            $password = $_POST['password'] ?? '';
        
            if (isset($users[$username]) && $users[$username]['password'] === $password) {
                // Set session variables
                $_SESSION['username'] = $username;
                $_SESSION['role'] = $users[$username]['role'];
                
                // Redirect to user.php after successful login
                header('Location: user.php');
                exit;
            }
            response('error', 'Invalid credentials');
            break;
        
        
    case 'profile':
        if(!isset($_SESSION['username'])) {
            response('error', 'Not authenticated');
        }
        response('success', 'Profile retrieved', [
            'username' => $_SESSION['username'],
            'role' => $_SESSION['role']
        ]);
        break;
        
    case 'update-profile':
        if(!isset($_SESSION['username'])) {
            response('error', 'Not authenticated');
        }
        
        // Vulnerable endpoint - no role checking
        $data = json_decode(file_get_contents('php://input'), true);
        if(isset($data['role'])) {
            $_SESSION['role'] = $data['role'];
            response('success', 'Profile updated', [
                'username' => $_SESSION['username'],
                'role' => $_SESSION['role']
            ]);
        }
        response('error', 'Invalid data');
        break;
        
    case 'get-flag':
        if(!isset($_SESSION['username']) || $_SESSION['role'] !== 'admin') {
            response('error', 'Unauthorized');
        }
        response('success', 'Flag retrieved', [
            'flag' => 'GRFLKS24{4P1_53CUR17Y_15_1MP0R74N7_7483QRGH4}'
        ]);
        break;
        
    default:
        response('error', 'Invalid action');
}
?>